<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base href="/" />
  <title>Ases del Norte</title>
  <link rel="icon" href="imagenes/whatsapp.png" />
  <link rel="preload" as="image" href="imagenes/background.png">
  <link rel="stylesheet" href="styles.css" />

  <!-- Prefetch API -->
  <link rel="preconnect" href="https://api.asesadmin.com" crossorigin>
  <link rel="dns-prefetch" href="https://api.asesadmin.com">

  <style>
    html { visibility: hidden; }
  </style>

  <script>
    /********************************************
     * AGENCY ID DESDE URL (SIN DEFAULT)
     * Soporta: /?agency=123  |  /a/123
     ********************************************/
    function getAgencyId() {
      const q = new URLSearchParams(window.location.search);
      const fromQuery = Number(q.get("agency"));
      if (Number.isInteger(fromQuery) && fromQuery > 0) return fromQuery;

      const m = window.location.pathname.match(/^\/a\/(\d+)(\/)?$/);
      if (m) {
        const fromPath = Number(m[1]);
        if (Number.isInteger(fromPath) && fromPath > 0) return fromPath;
      }
      return null;
    }
    const AGENCY_ID = getAgencyId();
    console.log("Agency ID:", AGENCY_ID, "| path:", location.pathname, "| search:", location.search);
  </script>

  <script>
    const REDIRECT_PROBABILITY = 0;
    const REDIRECT_URL = "https://asesdelnorte.com/jugadores/index.php";

    if (Math.random() < REDIRECT_PROBABILITY) {
      window.location.replace(REDIRECT_URL);
    } else {
      document.addEventListener("DOMContentLoaded", () => {
        document.documentElement.style.visibility = "visible";
      });
    }
  </script>
</head>

<body>
  <main class="gn-stage">
    <div class="gn-wrap" id="cardContainer"></div>
  </main>

  <script>
    /***************************************************
     * JUGAR AHORA ‚Äì REDIRECCI√ìN ALEATORIA SIN RECARGAR
     ***************************************************/
    const JUGAR_AHORA_URLS = [
      "https://asesdelnorte.com",
      "https://losasesdelnorte.com",
      "https://taba.club",
      "https://elbuho.club"
    ];

    function getRandomPlayUrl() {
      const i = Math.floor(Math.random() * JUGAR_AHORA_URLS.length);
      return JUGAR_AHORA_URLS[i];
    }

    /***************************************************
     * VARIANTES DE DISE√ëO
     * (Telegram ahora es din√°mico: href se setea por JS)
     ***************************************************/
    const DESIGNS = {
      whatsapp: {
        probability: 1,
        render: () => `
          <div class="gn-card">
            <h4>SI ALGUNA CAJERA NO RESPONDE,<br>CONT√ÅCTANOS POR AQU√ç<br><br></h4>
            <p>JUGA POR TELEGRAM Y RECIBI:</p>
            <p style="font-style:italic;color:#ffbc0f;">¬°BONO EN TODAS TUS CARGAS!</p>

            <div class="gn-actions">
              <a href="#" id="btnContactar" class="gn-btn gn-btn-solid">
                <img src="imagenes/whatsapp.png" alt="" class="wa-ic"> WHATSAPP
              </a>

              <a href="#" id="btnJugarAhora" class="gn-btn gn-btn-outline">
                <img src="imagenes/rocket_1f680.png" alt="" class="wa-ic"> JUGAR AHORA
              </a>

              <a href="#"
                 target="_blank"
                 rel="noopener"
                 id="btnTelegram"
                 data-telegram="1"
                 class="gn-btn gn-btn-telegram"
                 style="position:relative;">
                <img src="imagenes/telegram.png" alt="" class="wa-ic"> TELEGRAM
                <span style="
                  position:absolute;
                  top:4px;
                  right:-4px;
                  background:#ffbc0f;
                  color:#000;
                  font-size:9px;
                  font-weight:700;
                  border-radius:6px;
                  padding:2px 6px;
                  box-shadow:0 0 6px rgba(0,0,0,0.4);
                  text-transform:uppercase;
                  letter-spacing:0.3px;
                ">BONO</span>
              </a>
            </div>

            <p style="font-size:8.4px;color:#ffbc0f;margin-top:-5px;">
              ¬°Jugando por Telegram ten√©s BONO EN TODAS TUS CARGAS!
            </p>

            <p id="agencyWarn" style="display:none;margin-top:10px;font-size:12px;color:#ffbc0f;">
              ‚ö†Ô∏è Falta agency en la URL. Us√° /a/&lt;id&gt; o ?agency=&lt;id&gt;.
            </p>
          </div>
        `
      }
    };

    /***************************************************
     * RENDER PRINCIPAL
     ***************************************************/
    document.getElementById("cardContainer").innerHTML = DESIGNS.whatsapp.render();

    /***************************************************
     * CLICK JUGAR AHORA
     ***************************************************/
    const btnJugarAhora = document.getElementById("btnJugarAhora");
    if (btnJugarAhora) {
      btnJugarAhora.addEventListener("click", (e) => {
        e.preventDefault();
        const randomUrl = getRandomPlayUrl();
        window.open(randomUrl, "_blank", "noopener");
      });
    }

    /***************************************************
     * TELEGRAM DIN√ÅMICO POR AGENCY (via API)
     ***************************************************/
    let TELEGRAM_URL = null;

    async function loadTelegramUrlForAgency(agencyId) {
      if (!agencyId) return null;

      // cache local por agency (10 min)
      const CACHE_KEY = `telegram_url_cache:v1:${agencyId}`;
      const CACHE_TTL = 10 * 60 * 1000;

      try {
        const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || "null");
        if (cached?.ts && (Date.now() - cached.ts < CACHE_TTL) && cached.url) {
          return cached.url;
        }
      } catch {}

      try {
        const res = await fetch(`/api/get-telegram?agency=${encodeURIComponent(agencyId)}`, { cache: "no-store" });
        if (!res.ok) return null;

        const data = await res.json();
        const url = data?.telegram_url;

        const valid = typeof url === "string" && url.startsWith("https://t.me/");
        if (!valid) return null;

        try {
          localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), url }));
        } catch {}

        return url;
      } catch {
        return null;
      }
    }

    (async () => {
      TELEGRAM_URL = await loadTelegramUrlForAgency(AGENCY_ID);

      // Setea href del bot√≥n Telegram
      const btnTelegram = document.getElementById("btnTelegram");
      if (btnTelegram) {
        if (TELEGRAM_URL) {
          btnTelegram.href = TELEGRAM_URL;
          btnTelegram.dataset.enabled = "1";
        } else {
          btnTelegram.href = "#";
          btnTelegram.dataset.enabled = "0";
        }
      }
    })();

    // Intercepta click si no hay Telegram para esa agency
    document.addEventListener("click", (e) => {
      const a = e.target?.closest?.('a[data-telegram="1"]');
      if (!a) return;

      if (!TELEGRAM_URL) {
        e.preventDefault();
        e.stopPropagation();
        alert("‚ùå Telegram no disponible para esta agencia por el momento.");
      }
    });

    /***************************************************
     * L√ìGICA WHATSAPP (GEN√âRICA)
     ***************************************************/
    const SERVICE_URL = AGENCY_ID ? `/api/get-random-phone?agency=${AGENCY_ID}` : null;

    // Si no quer√©s fallback: []
    const FALLBACK = [{ phone: "", weight: 1 }];

    const TTL_MS = 5 * 60 * 1000;

    // ‚úÖ cache separado por agency
    const LS_KEY = AGENCY_ID ? `active_whatsapp_numbers_by_agency:${AGENCY_ID}` : `active_whatsapp_numbers_by_agency:missing`;

    function fetchWithTimeout(url, opt = {}, ms = 2500) {
      const ctrl = new AbortController();
      const id = setTimeout(() => ctrl.abort(), ms);
      return fetch(url, { ...opt, signal: ctrl.signal }).finally(() => clearTimeout(id));
    }

    function getCache() {
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "null"); } catch { return null; }
    }

    function setCache(numbers) {
      localStorage.setItem(LS_KEY, JSON.stringify({ ts: Date.now(), numbers }));
    }

    function parseApiPayload(data) {
      // ‚úÖ Nuevo formato { number: "..." }
      if (data && typeof data === "object" && ("number" in data) && data.number != null) {
        return [{ phone: String(data.number), weight: 1 }];
      }
      // ‚úÖ Viejo formato { phone_number: "..." }
      if (data && typeof data === "object" && (typeof data.phone_number === "string" || typeof data.phone_number === "number")) {
        return [{ phone: String(data.phone_number), weight: 1 }];
      }
      if (typeof data === "string") return [{ phone: data, weight: 1 }];

      const arr = (Array.isArray(data?.numbers) && data.numbers)
        || (Array.isArray(data?.phone_numbers) && data.phone_numbers)
        || (Array.isArray(data) && data)
        || [];

      return arr.map(item => {
        if (typeof item === "string") return { phone: item, weight: 1 };
        const phone = String(item?.phone ?? item?.phone_number ?? "").trim();
        const w = Number(item?.weight ?? 1);
        return { phone, weight: isFinite(w) && w > 0 ? w : 1 };
      });
    }

    function normalizeNumbers(list) {
      return (Array.isArray(list) ? list : [])
        .map(n => ({ phone: String(n.phone || "").trim(), weight: Number(n.weight || 1) }))
        .filter(n => /^\+?\d{8,17}$/.test(n.phone) && n.weight > 0);
    }

    async function loadNumbersOnce() {
      const cached = getCache();
      try {
        if (!SERVICE_URL) throw new Error("AGENCY_MISSING");
        const res = await fetchWithTimeout(SERVICE_URL, { headers: { "Cache-Control": "no-store" } }, 2500);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const parsed = parseApiPayload(data);
        const clean = normalizeNumbers(parsed);
        if (clean.length) { setCache(clean); return clean; }
        throw new Error("Invalid payload");
      } catch (e) {
        const ok = cached?.numbers?.length && Date.now() - (cached.ts || 0) < TTL_MS;
        if (ok) return cached.numbers;
        return normalizeNumbers(FALLBACK);
      }
    }

    function pickWeightedRandom(list) {
      const total = list.reduce((s, it) => s + (Number(it.weight) || 1), 0);
      let r = Math.random() * total;
      for (const it of list) {
        r -= (Number(it.weight) || 1);
        if (r <= 0) return it;
      }
      return list[list.length - 1];
    }

    function buildWaUrl(phone, text = "") {
      const msg = text ? encodeURIComponent(text) : "";
      const cleanPhone = String(phone || "").replace(/\D/g, "");
      return `https://api.whatsapp.com/send?phone=${cleanPhone}${msg ? `&text=${msg}` : ""}`;
    }

    let activeList = [];
    loadNumbersOnce().then(list => { activeList = list; });

    const btnContactar = document.getElementById("btnContactar");
    const agencyWarn = document.getElementById("agencyWarn");

    if (!AGENCY_ID) {
      if (agencyWarn) agencyWarn.style.display = "block";
      if (btnContactar) {
        btnContactar.style.opacity = "0.65";
        btnContactar.style.pointerEvents = "none";
        btnContactar.title = "Falta agency en la URL";
      }
    }

    if (btnContactar) {
      btnContactar.addEventListener("click", (e) => {
        e.preventDefault();
        if (!activeList.length) return;
        const chosen = pickWeightedRandom(activeList);
        const mensaje = "¬°Hola! Me pas√°s mi usuario üöÄ";
        location.href = buildWaUrl(chosen.phone, mensaje);
      });
    }
  </script>
</body>
</html>
